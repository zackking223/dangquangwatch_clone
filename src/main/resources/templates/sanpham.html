<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/images/LogoMobile.png">
    <title th:text="${title}">Thông tin bút ký</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link rel="stylesheet" th:href="@{/css/application.css}">
    <style>
        .aspect-ratio-1-1_2 {
            aspect-ratio: 1 / 1.2;
        }

        .aspect-ratio-1-1_2>img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .thumbnail {
            border: 2px solid transparent;
        }

        .thumbnail.selected {
            border-color: #eab308;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div class="w-full xl:max-w-[1215px] max-w-[1021px] mx-auto my-9">
        <div class="bg-white shadow-md rounded-lg overflow-hidden p-4 min-h-[85vh]">
            <div class="md:flex">
                <div id="slider-container"
                    class="relative lg:w-1/3 lg:mx-0 sm:w-1/2 sm:mx-auto w-full aspect-ratio-1-1_2 pb-[60px] h-fit">
                    <div class="overflow-hidden relative w-full h-full">
                        <div id="slider" class="flex transition-transform duration-500 ease-in-out overflow-visible">

                            <!-- Lặp qua từng ảnh -->
                            <div th:each="image : ${sanPham.getImages()}"
                                class="w-full flex-shrink-0 aspect-ratio-1-1_2 relative overflow-hidden">
                                <img th:src="${image.getUrl()}" th:alt="${image.getTenanh()}">
                            </div>

                        </div>
                    </div>
                    <button id="prevBtn"
                        class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-yellow-500 text-white p-2 opacity-20 hover:opacity-100 transition-all duration-75">⮜</button>
                    <button id="nextBtn"
                        class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-yellow-500 text-white p-2 opacity-20 hover:opacity-100 transition-all duration-75">⮞</button>
                    <div id="thumbnails" class="absolute bottom-0 left-0 right-0 flex justify-center gap-1">

                        <!-- Lặp qua từng ảnh -->
                        <div th:each="image : ${sanPham.getImages()}"
                            class="thumbnail selected w-[60px] h-[60px] aspect-square overflow-hidden">
                            <img th:src="${image.getUrl()}" th:alt="${image.getTenanh()}">
                        </div>

                    </div>
                </div>
                <div th:if="${sanPham.kichHoat == 1}" class="md:w-2/3 p-6">
                    <h1 class="text-2xl font-bold mb-4" th:text="${sanPham.getTen()}"></h1>
                    <section class="flex items-center gap-2 mb-4 text-2xl">
                        <p>Giá:</p>
                        <div id="priceContainer">
                            Vui lòng chọn màu và kích thước
                        </div>
                    </section>
                    <ul class="grid grid-cols-1 grid-rows-4 gap-4 mb-4 text-sm">
                        <li class="flex items-center gap-2">
                            <p>Màu sắc:</p>
                            <div id="colorsContainer" class="flex items-center flex-wrap gap-2"></div>
                        </li>
                        <li class="flex items-center gap-2">
                            <p>Kích thước:</p>
                            <div id="sizesContainer" class="flex items-center flex-wrap gap-2">Vui lòng chọn màu trước
                            </div>
                        </li>
                        <li class="flex items-center gap-2">
                            <span>Số lượng:</span>
                            <div id="maxAmountContainer" class="flex items-center flex-wrap gap-2">
                                Vui lòng chọn màu và kích thước trước
                            </div>
                        </li>
                    </ul>
                    <div th:if="${sanPham.kichHoat == 1}" class="flex gap-2">
                        <div class="flex items-center rounded border overflow-hidden">
                            <button onclick="dec()" class="p-2 bg-neutral-300 text-base font-bold">-</button>
                            <input name="amount" id="amountInput" class="text-center w-8 outline-none" value="0">
                            <button onclick="inc()" class="p-2 bg-neutral-300 text-base font-bold">+</button>
                        </div>
                        <button onclick="checkAndAddItem()"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex gap-2 items-center">
                            <img src="/svg/addtocart.svg" class="w-5 h-5" alt="addtocart">
                            <p class="text-xs sm:text-base">
                                Thêm vào giỏ
                            </p>
                        </button>
                    </div>

                    <div th:if="${sanPham.kichHoat == 0 || sanPham.getSoLuong() == 0}"
                        class="bg-slate-500 cursor-not-allowed text-white font-bold py-2 px-4 rounded w-max">
                        Sản phẩm ngừng kinh doanh
                    </div>
                </div>
            </div>
            <div class="my-8">
                <h1 class="p-2 text-xl bg-yellow-500 text-white w-max">Thông tin</h1>
                <div class="w-full h-1 bg-yellow-500 mb-2"></div>
                <p class="" th:text="${sanPham.getThongtin()}"></p>
            </div>
        </div>

    </div>
    <div th:replace="~{fragments/footer :: footer}"></div>
    <script th:inline="javascript">
        const colorsContainer = document.getElementById("colorsContainer");
        const sizesContainer = document.getElementById("sizesContainer");
        const maxAmountContainer = document.getElementById("maxAmountContainer");
        const priceContainer = document.getElementById("priceContainer");
        const amountInput = document.getElementById("amountInput");
        const sanPhamData = /*[[${sanPham}]]*/ '';
        console.log(sanPhamData);
        const bienTheList = sanPhamData.bienTheList;
        const imageList = sanPhamData.images;
        let maxAmount = null;
        let amount = 0;

        amountInput.addEventListener('change', e => {
            amount = parseInt(e.target.value);
        })

        // addItem = (tensanpham, maSanPham, loaiSanPham, giaTien, anhsanpham)
        let itemToAdd = {
            tenSanPham: sanPhamData.ten,
            maSanPham: null,
            loaiSanPham: sanPhamData.loai,
            giaTien: null,
            anhSanPham: null
        };
        let selectedColor = {
            mauSacId: null,
            ten: null
        };
        let selectedSize = null;

        function clearPrice() {
            priceContainer.textContent = "Vui lòng chọn màu và kích thước"
        }

        function resetAmount() {
            amount = 0;
            amountInput.value = 0;
            maxAmountContainer.textContent = "Vui lòng chọn màu và kích thước trước";
        }

        function updateMaxAmountAndPrice(bienTheData) {
            maxAmountContainer.textContent = bienTheData.soLuong;
            maxAmount = bienTheData.soLuong;
            amountInput.value = 1;
            amount = 1;
            priceContainer.textContent = bienTheData.giaTienFormatted + "₫";
        }

        function inc() {
            if (amount < maxAmount && maxAmount != null) {
                amount++;
                amountInput.value = amount;
                console.log("TEST");
            }
        }
        function dec() {
            if (amount > 1) {
                amount--;
                amountInput.value = amount;
            }
        }

        function clearItemData() {
            itemToAdd = {
                tenSanPham: sanPhamData.ten,
                maSanPham: null,
                loaiSanPham: sanPhamData.loai,
                giaTien: null,
                anhSanPham: null
            };
        }

        function getBienThe(kichThuocId, mauSacId) {
            const result = bienTheList.find(b => b.kichThuoc.kichThuocId === kichThuocId && b.mauSac.mauSacId === mauSacId);
            return result ? result : null;
        }

        function getImageUrl(mauSacId) {
            const result = imageList.find(i => i.mauSacId === mauSacId);
            return result ? result.url : null;
        }

        function extractAndGroupByColor(data) {
            const uniqueSizes = new Set();
            const colorGroups = new Map();

            data.forEach(item => {
                uniqueSizes.add(item.kichThuoc.kichThuocId);

                if (!colorGroups.has(item.mauSac.mauSacId)) {
                    colorGroups.set(item.mauSac.mauSacId, {
                        mauSac: item.mauSac,
                        kichThuocList: new Set()
                    });
                }

                colorGroups.get(item.mauSac.mauSacId).kichThuocList.add(item.kichThuoc.kichThuocId);
            });

            return {
                kichThuoc: [...uniqueSizes], // Danh sách kích thước không trùng
                mauSacGrouped: [...colorGroups.values()].map(group => ({
                    mauSac: group.mauSac,
                    kichThuocList: [...group.kichThuocList] // Convert Set to Array
                }))
            };
        }

        function checkAndAddItem() {
            if (selectedColor.mauSacId == null || selectedColor.ten == null) {
                showNotification({
                    title: "Lỗi",
                    message: "Vui lòng chọn màu và kích thước!",
                    type: "warning"
                });
                return;
            }

            if (selectedSize == null) {
                showNotification({
                    title: "Lỗi",
                    message: "Vui lòng chọn kích thước!",
                    type: "warning"
                });
                return;
            }

            if (amount > maxAmount) {
                showNotification({
                    title: "Lỗi",
                    message: "Số lượng mua quá lớn!",
                    type: "warning"
                });
                return;
            }

            if (amount < 1 || maxAmount == null) {
                showNotification({
                    title: "Lỗi",
                    message: "Hãy tăng số lượng!",
                    type: "warning"
                });
                return;
            }

            if (itemToAdd.anhSanPham != null && itemToAdd.maSanPham != null && itemToAdd.giaTien != null) {
                addItem(
                    itemToAdd.tenSanPham + " - " + selectedColor.ten + " - " + selectedSize,
                    itemToAdd.maSanPham,
                    itemToAdd.loaiSanPham,
                    itemToAdd.giaTien,
                    itemToAdd.anhSanPham,
                    amount
                );
            } else {
                showNotification({
                    title: "Lỗi",
                    message: "Vui lòng chọn màu và kích thước!",
                    type: "warning"
                });
            }
        }

        // Fill màu sắc và kích thước
        document.addEventListener("DOMContentLoaded", function () {
            const data = extractAndGroupByColor(sanPhamData.bienTheList);

            // Render màu sắc
            data.mauSacGrouped.forEach(group => {
                const colorButton = document.createElement("button");
                colorButton.classList.add("p-2", "border", "rounded-full");
                colorButton.style.backgroundColor = group.mauSac.mauSacId;
                colorButton.style.width = "32px";
                colorButton.style.height = "32px";
                colorButton.style.border = "2px solid gray";
                colorButton.title = group.mauSac.ten;

                colorButton.addEventListener("click", function () {
                    // Nếu click vào màu đang chọn -> reset
                    resetAmount();
                    if (selectedColor.mauSacId === group.mauSac.mauSacId) {
                        clearItemData();
                        selectedColor = { mauSacId: null, ten: null };
                        sizesContainer.innerHTML = "Vui lòng chọn màu trước";
                    } else {
                        selectedColor = {
                            mauSacId: group.mauSac.mauSacId,
                            ten: group.mauSac.ten
                        }
                        updateSizes(group.kichThuocList);
                    }

                    // Đổi màu viền để chỉ ra màu được chọn
                    document.querySelectorAll("#colorsContainer button").forEach(btn => {
                        btn.style.border = "2px solid gray";
                    });
                    if (selectedColor.mauSacId != null && selectedColor.ten != null) colorButton.style.border = "3px solid black";
                });

                colorsContainer.appendChild(colorButton);
            });

            // Cập nhật danh sách kích thước
            function updateSizes(sizes) {
                selectedSize = null;
                sizesContainer.innerHTML = ""; // Xóa nội dung cũ
                sizes.forEach(size => {
                    const sizeButton = document.createElement("button");
                    sizeButton.textContent = size;
                    sizeButton.classList.add("p-1", "rounded", "cursor-pointer");
                    sizeButton.style.border = "2px solid gray";
                    sizeButton.addEventListener("click", () => {
                        if (selectedSize === size) {
                            selectedSize = null;
                            resetAmount();
                            clearItemData();
                        } else {
                            selectedSize = size;
                            let bienTheData = getBienThe(selectedSize, selectedColor.mauSacId);
                            updateMaxAmountAndPrice(bienTheData);
                            itemToAdd = {
                                ...itemToAdd,
                                maSanPham: bienTheData.id,
                                giaTien: bienTheData.giaTien,
                                anhSanPham: getImageUrl(selectedColor.mauSacId)
                            }
                        }
                        document.querySelectorAll("#sizesContainer button").forEach(btn => {
                            btn.style.border = "2px solid gray";
                        });
                        if (selectedSize != null) sizeButton.style.border = "2px solid black";
                    });

                    sizesContainer.appendChild(sizeButton);
                });
            }
        });
    </script>
    <script>
        let currentIndex = 0;
        const slider = document.getElementById('slider');
        const thumbnails = document.querySelectorAll('.thumbnail');
        let autoSlideInterval = setInterval(nextSlide, 3000);

        function updateSlider() {
            slider.style.transform = `translateX(-${currentIndex * 100}%)`;
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('selected', index === currentIndex);
            });
        }

        function nextSlide() {
            currentIndex = (currentIndex + 1) % thumbnails.length;
            updateSlider();
        }

        function prevSlide() {
            currentIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
            updateSlider();
        }

        document.getElementById('nextBtn').addEventListener('click', nextSlide);
        document.getElementById('prevBtn').addEventListener('click', prevSlide);

        thumbnails.forEach((thumbnail, index) => {
            thumbnail.addEventListener('click', () => {
                currentIndex = index;
                updateSlider();
            });
        });

        const container = document.getElementById('slider-container');
        container.addEventListener('mouseover', () => clearInterval(autoSlideInterval));
        container.addEventListener('mouseout', () => autoSlideInterval = setInterval(nextSlide, 3000));

        updateSlider();
    </script>
</body>

</html>